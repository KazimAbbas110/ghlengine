(function waitForGHL() {
  const API_BASE = "https://ghle-theme-builder.vercel.app/api";
  const agencyCompanyId = window.agencyCompanyId; // must be set in GHL context

  if (!agencyCompanyId) return console.error("Agency Company ID missing");

  // Check if GHL dashboard DOM is ready
  const dashboardReady = document.querySelector('body'); // or change to a more specific GHL container
  if (!dashboardReady) return setTimeout(waitForGHL, 500);

  // Create floating control panel
  (async function createControlPanel() {
    try {
      const res = await fetch(`${API_BASE}/subaccount/agency/${agencyCompanyId}`);
      const data = await res.json();
      if (!data.success) return console.error("Failed to load subaccounts");

      // Remove old panel if exists
      const oldPanel = document.getElementById("agency-control-panel");
      if (oldPanel) oldPanel.remove();

      const panel = document.createElement("div");
      panel.id = "agency-control-panel";
      panel.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        width: 320px;
        max-height: 500px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 12px;
        padding: 15px;
        z-index: 99999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        font-family: sans-serif;
      `;
      panel.innerHTML = `<h4 style="margin-bottom:10px;">Agency Control Panel</h4>`;

      data.subAccounts.forEach(sub => {
        const div = document.createElement("div");
        div.style.marginBottom = "12px";
        div.style.padding = "8px";
        div.style.borderBottom = "1px solid #eee";
        div.innerHTML = `
          <strong>${sub.locationName}</strong> (ID: ${sub.locationId})<br>
          Access: ${sub.access ? '✅' : '❌'}<br>
          Theme: ${sub.themeId ? sub.themeId.name : 'None'}
        `;
        panel.appendChild(div);
      });

      document.body.appendChild(panel);

    } catch (e) {
      console.error("Failed to fetch agency subaccounts:", e);
    }
  })();
})();
