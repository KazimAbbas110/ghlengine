<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Theme Widget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { margin:0;padding:20px;font-family:Arial,sans-serif;transition:background-color 0.3s ease;}
.theme-widget { position:fixed; bottom:30px; right:30px; width:300px; background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.15); z-index:99999; }
.status-dot { width:10px;height:10px;border-radius:50%; background:#00ff5e; }
.theme-option { display:flex; align-items:center; padding:10px; border:1px solid #e0e0e0; border-radius:8px; cursor:pointer; transition:all 0.3s ease; }
.theme-option:hover { border-color:#4361ee; background:#f8f9ff; }
.theme-option.active { border-color:#4361ee; background:#f0f2ff; }
.theme-preview { width:40px;height:40px;border-radius:6px; display:flex;align-items:center;justify-content:center;color:white;margin-right:10px; }
.theme-details { flex:1; }
.theme-details h4 { margin:0 0 4px 0; font-size:14px; }
.theme-details p { margin:0;font-size:12px;color:#666; }
.btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:12px; transition:all 0.3s ease; }
.btn-primary { background:#4361ee;color:#fff; }
.btn-primary:hover { background:#3a56d4; }
.btn-secondary { background:#ccc;color:#333; }
.btn-secondary:hover { background:#b3b3b3; }
.btn-sm { padding:4px 8px; font-size:11px; }
.notification { position:fixed; top:20px; right:20px; background:white; padding:12px 16px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); display:flex; align-items:center; gap:8px; transform:translateX(400px); opacity:0; transition:all 0.3s ease; z-index:100000; }
.notification.show { transform:translateX(0); opacity:1; }
.notification.success { border-left:4px solid #00c853; }
.notification.error { border-left:4px solid #f44336; }
.notification.info { border-left:4px solid #2196f3; }
.notification.warning { border-left:4px solid #ff9800; }
.theme-widget.minimized .widget-content { display:none; }
</style>
</head>
<body>

<div class="theme-widget" id="themeWidget">
  <div id="widgetHeader" style="display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background:linear-gradient(135deg,#4361ee,#7209b7);color:#fff;border-radius:12px 12px 0 0;cursor:move;">
    <div style="display:flex;align-items:center;gap:8px;">
      <div id="statusDot" class="status-dot"></div>
      <span id="locationStatus">Loading...</span>
    </div>
    <div>
      <button id="minimizeBtn" style="background:none;border:none;color:white;font-size:14px;cursor:pointer;"><i class="fas fa-minus"></i></button>
      <button id="closeBtn" style="background:none;border:none;color:white;font-size:14px;margin-left:5px;cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div class="widget-content" style="padding:15px;">
    <h3 id="locationName" style="margin:0;font-size:16px;color:#333;">Loading...</h3>
    <p style="margin:5px 0 10px;font-size:13px;color:#666;">Theme: <span id="currentThemeName">None</span></p>

    <div>
      <h4 style="font-size:14px;margin-bottom:8px;">Available Themes</h4>
      <div id="themeOptions" style="display:flex;flex-direction:column;gap:10px;"></div>
    </div>

    <div style="margin-top:15px;">
      <h4 style="font-size:14px;margin-bottom:8px;">Background Color</h4>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <input type="color" id="backgroundColorPicker" value="#ffffff" style="width:40px;height:40px;border:none;">
        <div id="colorPreview" style="width:40px;height:40px;border-radius:8px;border:1px solid #ccc;background:#ffffff;"></div>
      </div>
      <div style="display:flex;gap:10px;">
        <button id="applyColorBtn" class="btn btn-primary" style="flex:1;">Apply</button>
        <button id="resetColorBtn" class="btn btn-secondary" style="flex:1;">Reset</button>
      </div>
    </div>

    <button id="removeThemeBtn" style="margin-top:15px;width:100%;padding:8px 0;background:#e63946;color:#fff;border:none;border-radius:8px;cursor:pointer;">
      <i class="fas fa-trash"></i> Remove Theme
    </button>
  </div>
</div>

<div id="notificationsContainer"></div>

<script>
let currentLocation=null, themes=[], currentTheme=null, currentBackgroundColor='#ffffff';
let isDragging=false, dragOffset={x:0,y:0}, currentPosition={x:30,y:30};
const THEME_URLS={ purple:'https://ghlengine.vercel.app/ghlengine-p.js', yellow:'https://ghlengine.vercel.app/ghlengine-y.js' };

let statusDotEl, locationStatusEl, locationNameEl, currentThemeNameEl, backgroundColorPickerEl, colorPreviewEl;

function showNotification(msg,type='info',duration=4000){
    const container=document.getElementById('notificationsContainer'); if(!container)return;
    const notif=document.createElement('div'); notif.className=`notification ${type}`;
    notif.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span>${msg}</span>`;
    container.appendChild(notif); setTimeout(()=>notif.classList.add('show'),50);
    setTimeout(()=>{notif.classList.remove('show'); setTimeout(()=>notif.remove(),300);}, duration);
}

function getElementSafe(id){ const el=document.getElementById(id); if(!el)console.warn(`Element with ID '${id}' not found`); return el; }
function initializeDomReferences(){
    statusDotEl=getElementSafe('statusDot');
    locationStatusEl=getElementSafe('locationStatus');
    locationNameEl=getElementSafe('locationName');
    currentThemeNameEl=getElementSafe('currentThemeName');
    backgroundColorPickerEl=getElementSafe('backgroundColorPicker');
    colorPreviewEl=getElementSafe('colorPreview');
}

async function apiCall(endpoint, options={}) {
    const API_BASE_URL='https://ghlengine-production.up.railway.app/api';
    const url=`${API_BASE_URL}${endpoint}`;
    const headers={ 'Content-Type':'application/json','Authorization':'Bearer 110', ...options.headers };
    const config={ method: options.method||'GET', headers, ...(options.body && { body: JSON.stringify(options.body) }) };
    try { const response=await fetch(url, config); if(!response.ok){ const errText=await response.text(); throw new Error(`HTTP ${response.status}: ${errText||response.statusText}`); } return await response.json(); } 
    catch(e){ console.error('API Error:',e); throw e; }
}

async function loadUserLocation(){
    try{
        showNotification('Loading location...','info');
        const response = await apiCall('/locations/real-time');
        if(response.success && response.data?.length){
            currentLocation=response.data[0];
            if(!currentLocation.locationId) currentLocation.locationId=currentLocation.id||currentLocation._id;
            locationNameEl.textContent=currentLocation.name;
            locationStatusEl.textContent='Active';
            statusDotEl.className='status-dot';

            if(currentLocation.currentTheme){
                currentTheme=currentLocation.currentTheme;
                currentThemeNameEl.textContent=currentTheme.name;
                if(currentTheme.previewImage) await loadThemeScript(currentTheme.previewImage);
            }
            if(currentLocation.backgroundColor){
                currentBackgroundColor=currentLocation.backgroundColor;
                backgroundColorPickerEl.value=currentBackgroundColor;
                colorPreviewEl.style.backgroundColor=currentBackgroundColor;
                document.body.style.backgroundColor=currentBackgroundColor;
            }
        } else { throw new Error('No locations found'); }
        showNotification('Location loaded','success',2000);
    } catch(e){
        console.error('Load location error:',e);
        currentLocation={ locationId:'default-location', name:'Default Location', active:true };
        locationNameEl.textContent=currentLocation.name;
        locationStatusEl.textContent='Ready';
        statusDotEl.className='status-dot';
        showNotification('Using default location','info');
    }
}

function loadThemes(){
    themes=[
        { id:'purple', name:'Purple Theme', description:'Professional purple theme', color:'linear-gradient(135deg, #7209b7 0%, #4361ee 100%)', scriptUrl:THEME_URLS.purple },
        { id:'yellow', name:'Yellow Theme', description:'Bright yellow theme', color:'linear-gradient(135deg, #ffd166 0%, #ff9e00 100%)', scriptUrl:THEME_URLS.yellow }
    ];
    populateThemeOptions();
}

function populateThemeOptions(){
    const container=getElementSafe('themeOptions'); if(!container)return;
    const currentId=currentTheme?.id||'';
    container.innerHTML=themes.map(t=>`
        <div class="theme-option ${t.id===currentId?'active':''}" data-theme-id="${t.id}">
            <div class="theme-preview" style="background:${t.color}"><i class="fas fa-paint-brush"></i></div>
            <div class="theme-details"><h4>${t.name}</h4><p>${t.description}</p></div>
            <button class="btn btn-primary btn-sm apply-theme-btn" data-theme-id="${t.id}"><i class="fas fa-check"></i> Apply</button>
        </div>
    `).join('');
    document.querySelectorAll('.apply-theme-btn').forEach(btn=>{
        btn.addEventListener('click',e=>{ e.stopPropagation(); applyTheme(btn.getAttribute('data-theme-id'), true); });
    });
}

function loadThemeScript(url){ return new Promise((resolve,reject)=>{
    document.querySelectorAll('script[data-theme-script]').forEach(s=>s.remove());
    const script=document.createElement('script'); script.src=url; script.setAttribute('data-theme-script','true');
    script.onload=()=>resolve(); script.onerror=()=>reject(new Error(`Failed to load theme script: ${url}`));
    document.head.appendChild(script);
}); }

async function applyTheme(themeId, saveToDB=true){
    if(!currentLocation) return showNotification('No location selected','error');
    const safeLocationId=currentLocation?.id||currentLocation?.locationId||currentLocation?._id;
    if(!safeLocationId) return showNotification('Missing location ID','error');

    try{
        showNotification('Applying theme...','info');
        const theme=themes.find(t=>t.id===themeId); if(!theme) return showNotification('Theme not found','error');
        await loadThemeScript(theme.scriptUrl);
        localStorage.setItem(`themeScript-${safeLocationId}`,theme.scriptUrl);

        if(saveToDB){
            const timestamp=Date.now(), uniqueName=`${theme.name}-${safeLocationId.substring(0,8)}-${timestamp}`;
            const themeData={ name:uniqueName, description:theme.description, locationId:safeLocationId, userId:'110', companyId:currentLocation.companyId||'default', previewImage:theme.scriptUrl, isActive:true, isGlobal:false };
            const createRes=await apiCall('/themes',{ method:'POST', body:themeData });
            if(createRes.success){
                const applyRes=await apiCall('/themes/apply',{ method:'POST', body:{ locationId:safeLocationId, themeId:createRes.data._id } });
                if(applyRes.success){
                    currentTheme=theme;
                    currentThemeNameEl.textContent=theme.name;
                    populateThemeOptions();
                    showNotification('Theme applied and saved!','success');
                }
            }
        } else { currentTheme=theme; currentThemeNameEl.textContent=theme.name; populateThemeOptions(); showNotification('Theme applied!','success'); }
    } catch(e){ console.error(e); showNotification('Error applying theme','error'); }
}

async function removeTheme(){
    if(!currentLocation) return showNotification('No location selected','error');
    if(!currentTheme && !document.querySelector('script[data-theme-script]')) return showNotification('No theme to remove','error');
    if(!confirm('Are you sure you want to remove the current theme?')) return;

    try{
        showNotification('Removing theme...','info');
        document.querySelectorAll('script[data-theme-script]').forEach(s=>s.remove());
        const safeLocationId=currentLocation?.id||currentLocation?.locationId||currentLocation?._id;
        if(safeLocationId) localStorage.removeItem(`themeScript-${safeLocationId}`);
        await apiCall('/themes/remove',{ method:'POST', body:{ locationId:safeLocationId } });
        currentTheme=null; currentThemeNameEl.textContent='No theme applied'; populateThemeOptions();
        showNotification('Theme removed!','success');
    } catch(e){ console.error(e); showNotification('Error removing theme','error'); }
}

function initBackgroundColorPicker(){
    backgroundColorPickerEl=getElementSafe('backgroundColorPicker');
    colorPreviewEl=getElementSafe('colorPreview');
    const applyBtn=getElementSafe('applyColorBtn'), resetBtn=getElementSafe('resetColorBtn');
    if(!backgroundColorPickerEl||!colorPreviewEl||!applyBtn||!resetBtn) return;

    backgroundColorPickerEl.addEventListener('input',e=>{ colorPreviewEl.style.backgroundColor=e.target.value; });
    applyBtn.addEventListener('click',()=>applyBackgroundColor(backgroundColorPickerEl.value));
    resetBtn.addEventListener('click',()=>{ backgroundColorPickerEl.value='#ffffff'; colorPreviewEl.style.backgroundColor='#ffffff'; applyBackgroundColor('#ffffff'); });
}

async function applyBackgroundColor(color){
    if(!currentLocation) return;
    try{
        document.body.style.backgroundColor=color; currentBackgroundColor=color;
        const safeLocationId=currentLocation?.id||currentLocation?.locationId||currentLocation?._id;
        if(safeLocationId) localStorage.setItem(`bgColor-${safeLocationId}`,color);
        showNotification('Background color saved!','success');
    } catch(e){ console.error(e); showNotification('Error applying background color','error'); }
}

function initDrag(){
    const widget=getElementSafe('themeWidget'), header=getElementSafe('widgetHeader'); if(!widget||!header) return;
    header.addEventListener('mousedown',startDrag); header.addEventListener('touchstart',startDrag);
    function startDrag(e){
        e.preventDefault(); isDragging=true;
        const clientX=e.clientX||e.touches[0].clientX, clientY=e.clientY||e.touches[0].clientY;
        const rect=widget.getBoundingClientRect(); dragOffset.x=clientX-rect.left; dragOffset.y=clientY-rect.top;
        document.addEventListener('mousemove',onDrag); document.addEventListener('touchmove',onDrag);
        document.addEventListener('mouseup',stopDrag); document.addEventListener('touchend',stopDrag);
    }
    function onDrag(e){
        if(!isDragging) return;
        const clientX=e.clientX||e.touches[0].clientX, clientY=e.clientY||e.touches[0].clientY;
        currentPosition.x=Math.max(0,Math.min(clientX-dragOffset.x,window.innerWidth-widget.offsetWidth));
        currentPosition.y=Math.max(0,Math.min(clientY-dragOffset.y,window.innerHeight-widget.offsetHeight));
        widget.style.left=currentPosition.x+'px'; widget.style.top=currentPosition.y+'px'; widget.style.right='auto'; widget.style.bottom='auto';
    }
    function stopDrag(){ isDragging=false; document.removeEventListener('mousemove',onDrag); document.removeEventListener('touchmove',onDrag); document.removeEventListener('mouseup',stopDrag); document.removeEventListener('touchend',stopDrag); }
}

function initControls(){
    const widget=getElementSafe('themeWidget'), minimizeBtn=getElementSafe('minimizeBtn'), closeBtn=getElementSafe('closeBtn'), removeBtn=getElementSafe('removeThemeBtn');
    if(!widget||!minimizeBtn||!closeBtn||!removeBtn) return;
    minimizeBtn.addEventListener('click',e=>{ e.stopPropagation(); widget.classList.toggle('minimized'); minimizeBtn.innerHTML=widget.classList.contains('minimized')?'<i class="fas fa-plus"></i>':'<i class="fas fa-minus"></i>'; });
    closeBtn.addEventListener('click',e=>{ e.stopPropagation(); widget.style.display='none'; setTimeout(()=>{ widget.style.display='block'; showNotification('Widget visible again','info'); },5000); showNotification('Widget hidden. Will reappear in 5s','info'); });
    removeBtn.addEventListener('click',removeTheme);
}

document.addEventListener('DOMContentLoaded',async()=>{
    initializeDomReferences();
    initDrag(); initControls(); initBackgroundColorPicker();
    await loadUserLocation(); loadThemes();

    // Restore theme & bg color
    try{
        const locationId=currentLocation?.id||currentLocation?.locationId||currentLocation?._id;
        if(locationId){
            const cachedTheme=localStorage.getItem(`themeScript-${locationId}`);
            if(cachedTheme){ await loadThemeScript(cachedTheme); const matched=themes.find(t=>t.scriptUrl===cachedTheme); if(matched){ currentTheme=matched; currentThemeNameEl.textContent=matched.name; populateThemeOptions(); } }

            const cachedBg=localStorage.getItem(`bgColor-${locationId}`);
            if(cachedBg){ document.body.style.backgroundColor=cachedBg; backgroundColorPickerEl.value=cachedBg; colorPreviewEl.style.backgroundColor=cachedBg; currentBackgroundColor=cachedBg; }

            // Refresh from DB
            try{
                const res=await apiCall(`/themes/by-location/${locationId}`);
                if(res?.success && res?.data?.previewImage && res.data.previewImage!==cachedTheme){
                    await loadThemeScript(res.data.previewImage); localStorage.setItem(`themeScript-${locationId}`,res.data.previewImage);
                    showNotification(`Theme "${res.data.name}" reapplied automatically`,'success');
                    const matched=themes.find(t=>t.scriptUrl===res.data.previewImage); if(matched){ currentTheme=matched; currentThemeNameEl.textContent=matched.name; populateThemeOptions(); }
                }
            } catch(dbError){ console.log('DB restore error:',dbError); }
        }
    } catch(e){ console.error('Restore error:',e); }
});
</script>

</body>
</html>
