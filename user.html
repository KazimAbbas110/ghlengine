<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Theme Widget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body {
  margin: 0;
  padding: 20px;
  font-family: Arial, sans-serif;
  transition: background-color 0.3s ease;
}

.theme-widget {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 300px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 99999;
  font-family: Arial, sans-serif;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #00ff5e;
}

.theme-option {
  display: flex;
  align-items: center;
  padding: 10px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.theme-option:hover {
  border-color: #4361ee;
  background: #f8f9ff;
}

.theme-option.active {
  border-color: #4361ee;
  background: #f0f2ff;
}

.theme-preview {
  width: 40px;
  height: 40px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  margin-right: 10px;
}

.theme-details {
  flex: 1;
}

.theme-details h4 {
  margin: 0 0 4px 0;
  font-size: 14px;
}

.theme-details p {
  margin: 0;
  font-size: 12px;
  color: #666;
}

.btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
}

.btn-primary {
  background: #4361ee;
  color: #fff;
}

.btn-primary:hover {
  background: #3a56d4;
}

.btn-secondary {
  background: #ccc;
  color: #333;
}

.btn-secondary:hover {
  background: #b3b3b3;
}

.btn-sm {
  padding: 4px 8px;
  font-size: 11px;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  padding: 12px 16px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;
  gap: 8px;
  transform: translateX(400px);
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 100000;
}

.notification.show {
  transform: translateX(0);
  opacity: 1;
}

.notification.success {
  border-left: 4px solid #00c853;
}

.notification.error {
  border-left: 4px solid #f44336;
}

.notification.info {
  border-left: 4px solid #2196f3;
}

.notification.warning {
  border-left: 4px solid #ff9800;
}

.theme-widget.minimized .widget-content {
  display: none;
}
</style>
</head>
<body>

<!-- Floating Theme Widget -->
<div class="theme-widget" id="themeWidget">
  <div id="widgetHeader" class="widget-header" style="display:flex;align-items:center;justify-content:space-between;padding:10px 15px;background:linear-gradient(135deg,#4361ee,#7209b7);color:#fff;border-radius:12px 12px 0 0;cursor:move;">
    <div style="display:flex;align-items:center;gap:8px;">
      <div id="statusDot" class="status-dot"></div>
      <span id="locationStatus">Loading...</span>
    </div>
    <div>
      <button id="minimizeBtn" style="background:none;border:none;color:white;font-size:14px;cursor:pointer;"><i class="fas fa-minus"></i></button>
      <button id="closeBtn" style="background:none;border:none;color:white;font-size:14px;margin-left:5px;cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div class="widget-content" style="padding:15px;">
    <h3 id="locationName" style="margin:0;font-size:16px;color:#333;">Loading...</h3>
    <p style="margin:5px 0 10px;font-size:13px;color:#666;">Theme: <span id="currentThemeName">None</span></p>

    <div>
      <h4 style="font-size:14px;margin-bottom:8px;">Available Themes</h4>
      <div id="themeOptions" style="display:flex;flex-direction:column;gap:10px;"></div>
    </div>

    <div style="margin-top:15px;">
      <h4 style="font-size:14px;margin-bottom:8px;">Background Color</h4>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <input type="color" id="backgroundColorPicker" value="#ffffff" style="width:40px;height:40px;border:none;">
        <div id="colorPreview" style="width:40px;height:40px;border-radius:8px;border:1px solid #ccc;background:#ffffff;"></div>
      </div>
      <div style="display:flex;gap:10px;">
        <button id="applyColorBtn" class="btn btn-primary" style="flex:1;padding:6px 0;border:none;background:#4361ee;color:#fff;border-radius:6px;cursor:pointer;">Apply</button>
        <button id="resetColorBtn" class="btn btn-secondary" style="flex:1;padding:6px 0;border:none;background:#ccc;color:#333;border-radius:6px;cursor:pointer;">Reset</button>
      </div>
    </div>

    <button id="removeThemeBtn" style="margin-top:15px;width:100%;padding:8px 0;background:#e63946;color:#fff;border:none;border-radius:8px;cursor:pointer;">
      <i class="fas fa-trash"></i> Remove Theme
    </button>
  </div>
</div>

<div id="notificationsContainer"></div>

<script>
// ====== JS Variables ======
let currentLocation = null;
let themes = [];
let isDragging = false;
let dragOffset = {x:0,y:0};
let currentPosition = {x:30,y:30};
let currentBackgroundColor = '#ffffff';
let currentTheme = null;

// Your hosted theme URLs
const THEME_URLS = {
  purple: 'https://ghlengine.vercel.app/ghlengine-p.js',
  yellow: 'https://ghlengine.vercel.app/ghlengine-y.js'
};

// ====== DOM Element References ======
let statusDotEl, locationStatusEl, locationNameEl, currentThemeNameEl, backgroundColorPickerEl, colorPreviewEl;

// ====== Generic API call ======
async function apiCall(endpoint, options = {}) {
    const API_BASE_URL = 'https://ghlengine-production.up.railway.app/api';
    const url = `${API_BASE_URL}${endpoint}`;
    const headers = { 
        'Content-Type': 'application/json', 
        'Authorization': 'Bearer 110', 
        ...options.headers 
    };
    
    const config = { 
        method: options.method || 'GET', 
        headers, 
        ...(options.body && { body: JSON.stringify(options.body) }) 
    };
    
    try {
        const response = await fetch(url, config);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
        }
        return await response.json();
    } catch (error) { 
        console.error('API Error:', error); 
        throw error; 
    }
}

// ====== Notifications ======
function showNotification(msg, type='info', duration=4000){
    const container = document.getElementById('notificationsContainer');
    if (!container) return;
    
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span>${msg}</span>`;
    container.appendChild(notif);
    setTimeout(()=>notif.classList.add('show'),50);
    setTimeout(()=>{notif.classList.remove('show'); setTimeout(()=>notif.remove(),300);}, duration);
}

// ====== Safe DOM Element Access ======
function getElementSafe(id) {
    const element = document.getElementById(id);
    if (!element) console.warn(`Element with ID '${id}' not found`);
    return element;
}

// ====== Initialize DOM References ======
function initializeDomReferences() {
    statusDotEl = getElementSafe('statusDot');
    locationStatusEl = getElementSafe('locationStatus');
    locationNameEl = getElementSafe('locationName');
    currentThemeNameEl = getElementSafe('currentThemeName');
    backgroundColorPickerEl = getElementSafe('backgroundColorPicker');
    colorPreviewEl = getElementSafe('colorPreview');
}

// ====== Load User Location ======
async function loadUserLocation(){
    try{
        showNotification('Loading location...', 'info');
        const response = await apiCall('/locations/real-time');
        if(response.success && response.data && response.data.length){
            currentLocation = response.data[0];

            // âœ… Add locationId fallback for compatibility
            if (!currentLocation.locationId && (currentLocation.id || currentLocation._id)) {
                currentLocation.locationId = currentLocation.id || currentLocation._id;
            }

            if (locationNameEl) locationNameEl.textContent = currentLocation.name;
            if (locationStatusEl) locationStatusEl.textContent = 'Active';
            if (statusDotEl) statusDotEl.className = 'status-dot';
            
            // âœ… Load saved theme from sub-account
            if(currentLocation.currentTheme){
                if (currentThemeNameEl) currentThemeNameEl.textContent = currentLocation.currentTheme.name;
                currentTheme = currentLocation.currentTheme;
                
                // Apply the saved theme from previewImage field
                if (currentLocation.currentTheme.previewImage) {
                    await loadThemeScript(currentLocation.currentTheme.previewImage);
                    showNotification('Theme loaded from database', 'success', 2000);
                }
            } else {
                if (currentThemeNameEl) currentThemeNameEl.textContent = 'No theme applied';
            }

            if(currentLocation.backgroundColor){
                currentBackgroundColor = currentLocation.backgroundColor;
                if (backgroundColorPickerEl) backgroundColorPickerEl.value = currentBackgroundColor;
                if (colorPreviewEl) colorPreviewEl.style.backgroundColor = currentBackgroundColor;
                document.body.style.backgroundColor = currentBackgroundColor;
            }
        } else {
            currentLocation = {
                locationId: 'default-location',
                name: 'Default Location',
                active: true
            };
            if (locationNameEl) locationNameEl.textContent = currentLocation.name;
        }
        showNotification('Location loaded', 'success', 2000);
    } catch(e){
        console.error('Load location error:', e);
        currentLocation = {
            locationId: 'default-location',
            name: 'Default Location',
            active: true
        };
        if (locationNameEl) locationNameEl.textContent = currentLocation.name;
        if (locationStatusEl) locationStatusEl.textContent = 'Ready';
        if (statusDotEl) statusDotEl.className = 'status-dot';
        showNotification('Using default location', 'info');
    }
}

// ====== Load Themes ======
function loadThemes(){
    themes = [
        {
            id: 'purple',
            name: 'Purple Theme',
            description: 'Professional purple theme with modern gradient design',
            color: 'linear-gradient(135deg, #7209b7 0%, #4361ee 100%)',
            scriptUrl: THEME_URLS.purple,
            addBarColor: '#7209b7',
            gradientColor: '#7209b7',
            hoverColor: '#5a08a5',
            textColor: '#FFFFFF',
            backgroundColor: '#FFFFFF',
            buttonBgColor: '#7209b7',
            buttonTextColor: '#FFFFFF',
            buttonHoverColor: '#5a08a5',
            fontFamily: 'Arial, sans-serif',
            headingFontSize: '14px',
            bodyFontSize: '12px',
            borderRadius: '8px',
            transitionSpeed: '0.3s'
        },
        {
            id: 'yellow',
            name: 'Yellow Theme',
            description: 'Bright and energetic yellow theme',
            color: 'linear-gradient(135deg, #ffd166 0%, #ff9e00 100%)',
            scriptUrl: THEME_URLS.yellow,
            addBarColor: '#ff9e00',
            gradientColor: '#ff9e00',
            hoverColor: '#e68a00',
            textColor: '#000000',
            backgroundColor: '#FFFFFF',
            buttonBgColor: '#ff9e00',
            buttonTextColor: '#000000',
            buttonHoverColor: '#e68a00',
            fontFamily: 'Arial, sans-serif',
            headingFontSize: '14px',
            bodyFontSize: '12px',
            borderRadius: '8px',
            transitionSpeed: '0.3s'
        }
    ];
    
    populateThemeOptions();
}

// ====== Populate Theme Options ======
function populateThemeOptions(){
    const container = getElementSafe('themeOptions');
    if(!container) return;
    
    if(!themes.length){
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--gray)">No themes available</div>';
        return;
    }
    
    const currentId = currentTheme ? currentTheme.id : '';
    container.innerHTML = themes.map(t=>`
        <div class="theme-option ${t.id===currentId?'active':''}" data-theme-id="${t.id}">
            <div class="theme-preview" style="background:${t.color}">
                <i class="fas fa-paint-brush"></i>
            </div>
            <div class="theme-details">
                <h4>${t.name}</h4>
                <p>${t.description}</p>
            </div>
            <button class="btn btn-primary btn-sm apply-theme-btn" data-theme-id="${t.id}">
                <i class="fas fa-check"></i> Apply
            </button>
        </div>
    `).join('');

    document.querySelectorAll('.apply-theme-btn').forEach(btn=>{
        btn.addEventListener('click', e=>{
            e.stopPropagation();
            applyTheme(btn.getAttribute('data-theme-id'), true);
        });
    });
}

// ====== Load Theme Script ======
function loadThemeScript(url) {
    return new Promise((resolve, reject) => {
        // Remove any existing theme scripts
        const existingScripts = document.querySelectorAll('script[data-theme-script]');
        existingScripts.forEach(script => script.remove());
        
        // Create new script element
        const script = document.createElement('script');
        script.src = url;
        script.setAttribute('data-theme-script', 'true');
        script.onload = () => {
            console.log('Theme script loaded successfully:', url);
            resolve();
        };
        script.onerror = () => {
            console.error('Failed to load theme script:', url);
            reject(new Error(`Failed to load theme script: ${url}`));
        };
        document.head.appendChild(script);
    });
}

// ====== Apply Theme (with save + persist) ======
async function applyTheme(themeId, saveToDB = true) {
  if (!currentLocation) return showNotification('No location selected', 'error');

  const safeLocationId = currentLocation?.id || currentLocation?.locationId || currentLocation?._id;
  if (!safeLocationId) {
    console.error('âŒ Missing locationId in currentLocation:', currentLocation);
    return showNotification('Missing location ID â€“ cannot save theme.', 'error');
  }

  try {
    showNotification('Applying theme...', 'info');
    const theme = themes.find(t => t.id === themeId);
    if (!theme) return showNotification('Theme not found', 'error');

    // âœ… Load and apply immediately
    await loadThemeScript(theme.scriptUrl);

    // âš¡ Save locally for instant reloads
    localStorage.setItem(`themeScript-${safeLocationId}`, theme.scriptUrl);

    if (saveToDB) {
      const timestamp = Date.now();
      const uniqueThemeName = `${theme.name} - ${safeLocationId.substring(0, 8)} - ${timestamp}`;

      const themeData = {
        name: uniqueThemeName,
        description: theme.description,
        locationId: safeLocationId,
        userId: '110',
        companyId: currentLocation.companyId || 'default-company',
        previewImage: theme.scriptUrl,
        addBarColor: theme.addBarColor,
        gradientColor: theme.gradientColor,
        hoverColor: theme.hoverColor,
        textColor: theme.textColor,
        backgroundColor: theme.backgroundColor,
        buttonBgColor: theme.buttonBgColor,
        buttonTextColor: theme.buttonTextColor,
        buttonHoverColor: theme.buttonHoverColor,
        fontFamily: theme.fontFamily,
        headingFontSize: theme.headingFontSize,
        bodyFontSize: theme.bodyFontSize,
        borderRadius: theme.borderRadius,
        transitionSpeed: theme.transitionSpeed,
        category: 'dashboard',
        isActive: true,
        isGlobal: false,
        version: 1
      };

      console.log('ðŸ“¤ Creating theme first...');
      const createResponse = await apiCall('/themes', { method: 'POST', body: themeData });

      if (createResponse.success) {
        const createdThemeId = createResponse.data._id;
        console.log('âœ… Theme created with ID:', createdThemeId);
        console.log('ðŸ“¤ Applying theme to location...');

        const applyResponse = await apiCall('/themes/apply', {
          method: 'POST',
          body: { locationId: safeLocationId, themeId: createdThemeId }
        });

        if (applyResponse.success) {
          showNotification('Theme applied and saved!', 'success');
          currentTheme = theme;
          if (currentThemeNameEl) currentThemeNameEl.textContent = theme.name;
          populateThemeOptions();
        }
      }
    } else {
      // Just update UI without saving to DB
      currentTheme = theme;
      if (currentThemeNameEl) currentThemeNameEl.textContent = currentTheme.name;
      populateThemeOptions();
      showNotification('Theme applied!', 'success');
    }
  } catch (e) {
    console.error(e);
    showNotification('Error applying theme', 'error');
  }
}

// ====== Remove Theme ======
async function removeTheme() {
  if (!currentLocation) return showNotification('No location selected', 'error');
  if (!currentTheme && !document.querySelector('script[data-theme-script]'))
    return showNotification('No theme to remove', 'error');

  if (!confirm('Are you sure you want to remove the current theme?')) return;

  try {
    showNotification('Removing theme...', 'info');
    document.querySelectorAll('script[data-theme-script]').forEach(script => script.remove());

    // âœ… Remove from local storage
    const safeLocationId = currentLocation?.id || currentLocation?.locationId || currentLocation?._id;
    if (safeLocationId) {
      localStorage.removeItem(`themeScript-${safeLocationId}`);
    }

    // âœ… Always use correct locationId
    if (!safeLocationId) {
      console.error('âŒ Missing locationId in currentLocation:', currentLocation);
      return showNotification('Missing location ID â€“ cannot remove theme.', 'error');
    }

    try {
      const res = await apiCall('/themes/remove', {
        method: 'POST',
        body: { locationId: safeLocationId }
      });

      if (res.success) {
        showNotification('Theme removed!', 'success');
      } else {
        showNotification(`Theme removed but failed to update DB: ${res.message || 'Unknown error'}`, 'warning');
      }
    } catch (apiError) {
      console.error('Failed to remove theme from DB:', apiError);
      showNotification('Theme removed but failed to update database', 'warning');
    }

    currentTheme = null;
    if (currentThemeNameEl) currentThemeNameEl.textContent = 'No theme applied';
    populateThemeOptions();
  } catch (e) {
    console.error(e);
    showNotification('Error removing theme', 'error');
  }
}

// ====== Background Color Functions ======
function initBackgroundColorPicker() {
    backgroundColorPickerEl = getElementSafe('backgroundColorPicker');
    colorPreviewEl = getElementSafe('colorPreview');
    const applyColorBtn = getElementSafe('applyColorBtn');
    const resetColorBtn = getElementSafe('resetColorBtn');
    
    if (!backgroundColorPickerEl || !colorPreviewEl || !applyColorBtn || !resetColorBtn) {
        console.error('Background color picker elements not found');
        return;
    }
    
    // Update preview when color picker changes
    backgroundColorPickerEl.addEventListener('input', (e) => {
        colorPreviewEl.style.backgroundColor = e.target.value;
    });
    
    // Apply background color
    applyColorBtn.addEventListener('click', async () => {
        const color = backgroundColorPickerEl.value;
        await applyBackgroundColor(color);
    });
    
    // Reset to default
    resetColorBtn.addEventListener('click', async () => {
        backgroundColorPickerEl.value = '#ffffff';
        colorPreviewEl.style.backgroundColor = '#ffffff';
        await applyBackgroundColor('#ffffff');
    });
}

async function applyBackgroundColor(color) {
    if (!currentLocation) return;
    
    try {
        showNotification('Applying background color...', 'info');
        
        // Apply color to page
        document.body.style.backgroundColor = color;
        currentBackgroundColor = color;
        
        // Save to localStorage
        const safeLocationId = currentLocation?.id || currentLocation?.locationId || currentLocation?._id;
        if (safeLocationId) {
          localStorage.setItem(`bgColor-${safeLocationId}`, color);
        }
        
        showNotification('Background color saved!', 'success');
        
    } catch (e) {
        console.error('Error applying background color:', e);
        showNotification('Error applying background color', 'error');
    }
}

// ====== Drag Widget ======
function initDrag(){
    const widget = getElementSafe('themeWidget');
    const header = getElementSafe('widgetHeader');
    
    if (!widget || !header) {
        console.error('Widget elements not found for drag initialization');
        return;
    }
    
    header.addEventListener('mousedown', startDrag);
    header.addEventListener('touchstart', startDrag);

    function startDrag(e){
        e.preventDefault(); 
        isDragging=true;
        const clientX=e.clientX||e.touches[0].clientX;
        const clientY=e.clientY||e.touches[0].clientY;
        const rect=widget.getBoundingClientRect();
        dragOffset.x=clientX-rect.left; 
        dragOffset.y=clientY-rect.top;
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function onDrag(e){
        if(!isDragging) return;
        const clientX=e.clientX||e.touches[0].clientX;
        const clientY=e.clientY||e.touches[0].clientY;
        currentPosition.x=clientX-dragOffset.x;
        currentPosition.y=clientY-dragOffset.y;
        const maxX=window.innerWidth-widget.offsetWidth;
        const maxY=window.innerHeight-widget.offsetHeight;
        currentPosition.x=Math.max(0,Math.min(currentPosition.x,maxX));
        currentPosition.y=Math.max(0,Math.min(currentPosition.y,maxY));
        widget.style.left=currentPosition.x+'px';
        widget.style.top=currentPosition.y+'px';
        widget.style.right='auto';
        widget.style.bottom='auto';
    }
    
    function stopDrag(){
        isDragging=false;
        document.removeEventListener('mousemove',onDrag);
        document.removeEventListener('touchmove',onDrag);
        document.removeEventListener('mouseup',stopDrag);
        document.removeEventListener('touchend',stopDrag);
    }
}

// ====== Controls ======
function initControls(){
    const widget = getElementSafe('themeWidget');
    const minimizeBtn = getElementSafe('minimizeBtn');
    const closeBtn = getElementSafe('closeBtn');
    const removeBtn = getElementSafe('removeThemeBtn');

    if (!widget || !minimizeBtn || !closeBtn || !removeBtn) {
        console.error('Control elements not found');
        return;
    }

    minimizeBtn.addEventListener('click', e=>{
        e.stopPropagation();
        widget.classList.toggle('minimized');
        minimizeBtn.innerHTML = widget.classList.contains('minimized') ? '<i class="fas fa-plus"></i>' : '<i class="fas fa-minus"></i>';
    });

    closeBtn.addEventListener('click', e=>{
        e.stopPropagation();
        widget.style.display='none';
        setTimeout(()=>{
          widget.style.display='block';
          showNotification('Widget is now visible again','info');
        },5000);
        showNotification('Widget hidden. Will reappear in 5 seconds','info');
    });

    removeBtn.addEventListener('click', removeTheme);
}

// ====== Initialize ======
document.addEventListener('DOMContentLoaded', async ()=>{
  // Initialize DOM references first
  initializeDomReferences();
  
  // Then initialize functionality
  initDrag();
  initControls();
  initBackgroundColorPicker();
  await loadUserLocation();
  loadThemes();

  // =============================
  // âš¡ Restore Theme on Refresh
  // =============================
  try {
    const locationId = currentLocation?.id || currentLocation?.locationId || currentLocation?._id;
    if (locationId) {
      // ðŸ”¹ Step 1: Instant localStorage load
      const cachedThemeUrl = localStorage.getItem(`themeScript-${locationId}`);
      if (cachedThemeUrl) {
        await loadThemeScript(cachedThemeUrl);
        console.log('âš¡ Loaded theme instantly from localStorage');
        
        // Find the matching theme object
        const matchedTheme = themes.find(t => t.scriptUrl === cachedThemeUrl);
        if (matchedTheme) {
          currentTheme = matchedTheme;
          if (currentThemeNameEl) currentThemeNameEl.textContent = matchedTheme.name;
          populateThemeOptions();
        }
      }

      // ðŸ”¹ Step 2: Restore background color
      const cachedBgColor = localStorage.getItem(`bgColor-${locationId}`);
      if (cachedBgColor) {
        document.body.style.backgroundColor = cachedBgColor;
        if (backgroundColorPickerEl) backgroundColorPickerEl.value = cachedBgColor;
        if (colorPreviewEl) colorPreviewEl.style.backgroundColor = cachedBgColor;
        currentBackgroundColor = cachedBgColor;
      }

      // ðŸ”¹ Step 3: Verify and refresh from DB (optional)
      try {
        const res = await apiCall(`/themes/by-location/${locationId}`);
        if (res?.success && res?.data) {
          const theme = res.data;
          console.log('ðŸŽ¨ Restoring saved theme from DB:', theme.name);
          if (theme.previewImage && theme.previewImage !== cachedThemeUrl) {
            await loadThemeScript(theme.previewImage);
            localStorage.setItem(`themeScript-${locationId}`, theme.previewImage);
            showNotification(`Theme "${theme.name}" reapplied automatically`, 'success');
            
            // Find the matching theme object
            const matchedTheme = themes.find(t => t.scriptUrl === theme.previewImage);
            if (matchedTheme) {
              currentTheme = matchedTheme;
              if (currentThemeNameEl) currentThemeNameEl.textContent = matchedTheme.name;
              populateThemeOptions();
            }
          }
        }
      } catch (dbError) {
        console.log('No theme found in database or API error:', dbError);
      }
    }
  } catch (e) {
    console.error('Failed to restore theme:', e);
  }
});
</script>

</body>
</html>
