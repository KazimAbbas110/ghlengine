<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Theme Widget</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --success: #06d6a0;
  --danger: #ef476f;
  --dark: #2b2d42;
  --light: #f8f9fa;
  --gray: #6c757d;
  --gray-light: #e9ecef;
  --border-radius: 12px;
  --box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI',sans-serif; background:#f5f7fa; color:var(--dark); transition: background-color 0.3s ease; }
.theme-widget {
  position: fixed; bottom:30px; right:30px; width:350px;
  background:white; border-radius:var(--border-radius);
  box-shadow:var(--box-shadow); z-index:10000; overflow:hidden;
  user-select:none;
}
.theme-widget.minimized { width:60px; height:60px; }
.widget-header { background:var(--primary); color:white; padding:15px; cursor:move; display:flex; justify-content:space-between; align-items:center; }
.widget-title { display:flex; align-items:center; gap:10px; font-weight:600; }
.widget-actions { display:flex; gap:10px; }
.widget-action-btn { background:none; border:none; color:white; cursor:pointer; font-size:16px; width:24px; height:24px; display:flex; align-items:center; justify-content:center; border-radius:4px; transition:background 0.2s; }
.widget-action-btn:hover { background: rgba(255,255,255,0.2); }
.widget-body { padding:20px; max-height:400px; overflow-y:auto; }
.location-info { background:var(--light); padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; }
.location-name { font-weight:600; font-size:18px; margin-bottom:5px; }
.location-status { display:flex; align-items:center; justify-content:center; gap:8px; font-size:14px; color:var(--gray); }
.status-dot { width:10px; height:10px; border-radius:50%; background:var(--success); }
.status-dot.inactive { background:var(--gray); }
.current-theme { background:white; border:1px solid var(--gray-light); border-radius:8px; padding:15px; margin-bottom:20px; text-align:center; }
.current-theme h3 { font-size:16px; margin-bottom:10px; color:var(--dark); }
.theme-name { font-weight:600; color:var(--primary); font-size:18px; margin-bottom:15px; }
.theme-actions { display:flex; gap:10px; justify-content:center; }
.btn { display:inline-flex; align-items:center; gap:6px; padding:8px 16px; border:none; border-radius:6px; font-weight:600; font-size:14px; cursor:pointer; transition:all 0.2s ease; }
.btn:hover { transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.1); }
.btn-primary { background:var(--primary); color:white; }
.btn-primary:hover { background:var(--primary-dark); }
.btn-danger { background:var(--danger); color:white; }
.btn-outline { background:transparent; border:1px solid var(--gray-light); color:var(--dark); }
.btn-outline:hover { background:var(--gray-light); }
.btn-sm { padding:8px 16px; font-size:14px; }
.theme-selector { margin-bottom:20px; }
.theme-selector h3 { font-size:16px; margin-bottom:10px; color:var(--dark); }
.theme-options { display:flex; flex-direction:column; gap:10px; max-height:200px; overflow-y:auto; }
.theme-option { display:flex; align-items:center; gap:10px; padding:12px; border:1px solid var(--gray-light); border-radius:6px; cursor:pointer; transition:all 0.2s; }
.theme-option:hover { border-color:var(--primary); background: rgba(67,97,238,0.05); }
.theme-option.active { border-color:var(--primary); background: rgba(67,97,238,0.1); }
.theme-preview { width:40px; height:40px; border-radius:6px; background:linear-gradient(135deg, var(--primary) 0%, #7209b7 100%); display:flex; align-items:center; justify-content:center; color:white; font-size:18px; }
.theme-details { flex:1; }
.theme-details h4 { font-size:14px; margin-bottom:4px; }
.theme-details p { font-size:12px; color:var(--gray); }
.notification { position:fixed; top:20px; right:20px; padding:12px 18px; border-radius:var(--border-radius); color:white; font-weight:600; z-index:1000; box-shadow:var(--box-shadow); transform:translateX(150%); transition:transform 0.3s ease; display:flex; align-items:center; gap:10px; }
.notification.show { transform:translateX(0); }
.notification.success { background:var(--success); }
.notification.error { background:var(--danger); }
.notification.info { background:var(--primary); }
.minimized .widget-body { display:none; }
.widget-footer { padding:15px; border-top:1px solid var(--gray-light); text-align:center; font-size:12px; color:var(--gray); }
.loading { display:inline-block; width:20px; height:20px; border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:white; animation:spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Background Color Picker Styles */
.background-color-picker { margin-bottom:20px; }
.background-color-picker h3 { font-size:16px; margin-bottom:10px; color:var(--dark); }
.color-picker-controls { display:flex; gap:10px; align-items:center; margin-bottom:15px; }
.color-input-group { display:flex; flex:1; gap:8px; }
.color-input { flex:1; height:40px; border:1px solid var(--gray-light); border-radius:6px; cursor:pointer; }
.color-preview { width:40px; height:40px; border-radius:6px; border:1px solid var(--gray-light); }
.color-actions { display:flex; gap:8px; }
.preset-colors { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
.color-preset { width:100%; aspect-ratio:1; border-radius:6px; border:1px solid var(--gray-light); cursor:pointer; transition:transform 0.2s; }
.color-preset:hover { transform:scale(1.05); }
.color-preset.active { border:2px solid var(--primary); box-shadow:0 0 0 2px rgba(67,97,238,0.2); }

@media (max-width:480px){.theme-widget{width:calc(100vw-40px); right:20px; bottom:20px;}}
</style>
</head>
<body>

<!-- Floating Theme Widget -->
<div class="theme-widget" id="themeWidget">
  <div class="widget-header" id="widgetHeader">
    <div class="widget-title"><i class="fas fa-palette"></i><span>Theme Manager</span></div>
    <div class="widget-actions">
      <button class="widget-action-btn" id="minimizeBtn" aria-label="Minimize"><i class="fas fa-minus"></i></button>
      <button class="widget-action-btn" id="closeBtn" aria-label="Close"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <div class="widget-body">
    <div class="location-info">
      <div class="location-name" id="locationName">Theme Settings</div>
      <div class="location-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="locationStatus">Checking status...</span>
      </div>
    </div>

    <div class="current-theme">
      <h3>Current Theme</h3>
      <div class="theme-name" id="currentThemeName">No theme applied</div>
      <div class="theme-actions">
        <button class="btn btn-danger btn-sm" id="removeThemeBtn"><i class="fas fa-trash-alt"></i> Remove Theme</button>
      </div>
    </div>

    <!-- Background Color Picker Section -->
    <div class="background-color-picker">
      <h3>Background Color</h3>
      <div class="color-picker-controls">
        <div class="color-input-group">
          <input type="color" id="backgroundColorPicker" class="color-input" value="#ffffff" aria-label="Select background color">
          <div id="colorPreview" class="color-preview" style="background-color: #ffffff;"></div>
        </div>
        <div class="color-actions">
          <button class="btn btn-primary btn-sm" id="applyColorBtn"><i class="fas fa-check"></i> Apply</button>
          <button class="btn btn-outline btn-sm" id="resetColorBtn"><i class="fas fa-undo"></i> Reset</button>
        </div>
      </div>
      <div class="preset-colors">
        <div class="color-preset" style="background-color:#ffffff;" data-color="#ffffff" aria-label="White"></div>
        <div class="color-preset" style="background-color:#f8f9fa;" data-color="#f8f9fa" aria-label="Light gray"></div>
        <div class="color-preset" style="background-color:#e9ecef;" data-color="#e9ecef" aria-label="Gray"></div>
        <div class="color-preset" style="background-color:#dee2e6;" data-color="#dee2e6" aria-label="Medium gray"></div>
        <div class="color-preset" style="background-color:#4361ee;" data-color="#4361ee" aria-label="Blue"></div>
        <div class="color-preset" style="background-color:#3a56d4;" data-color="#3a56d4" aria-label="Dark blue"></div>
        <div class="color-preset" style="background-color:#7209b7;" data-color="#7209b7" aria-label="Purple"></div>
        <div class="color-preset" style="background-color:#06d6a0;" data-color="#06d6a0" aria-label="Green"></div>
      </div>
    </div>

    <div class="theme-selector">
      <h3>Available Themes</h3>
      <div class="theme-options" id="themeOptions">
        <!-- Theme options will be populated by JavaScript -->
      </div>
    </div>
  </div>
  <div class="widget-footer">Drag to move â€¢ Click to interact</div>
</div>

<div id="notificationsContainer"></div>

<script>
// ====== JS Variables ======
let currentLocation = null;
let themes = [];
let isDragging = false;
let dragOffset = {x:0,y:0};
let currentPosition = {x:30,y:30};
let currentBackgroundColor = '#ffffff';
let currentTheme = null;

// Your hosted theme URLs
const THEME_URLS = {
  purple: 'https://ghlengine.vercel.app/ghlengine-p.js',
  yellow: 'https://ghlengine.vercel.app/ghlengine-y.js'
};

// ====== DOM Element References ======
let statusDotEl, locationStatusEl, locationNameEl, currentThemeNameEl, backgroundColorPickerEl, colorPreviewEl;

// ====== Generic API call ======
async function apiCall(endpoint, options = {}) {
    const API_BASE_URL = 'https://ghlengine-production.up.railway.app/api';
    const url = `${API_BASE_URL}${endpoint}`;
    const headers = { 
        'Content-Type': 'application/json', 
        'Authorization': 'Bearer 110', 
        ...options.headers 
    };
    
    const config = { 
        method: options.method || 'GET', 
        headers, 
        ...(options.body && { body: JSON.stringify(options.body) }) 
    };
    
    try {
        const response = await fetch(url, config);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
        }
        return await response.json();
    } catch (error) { 
        console.error('API Error:', error); 
        throw error; 
    }
}

// ====== Notifications ======
function showNotification(msg, type='info', duration=4000){
    const container = document.getElementById('notificationsContainer');
    if (!container) return;
    
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span>${msg}</span>`;
    container.appendChild(notif);
    setTimeout(()=>notif.classList.add('show'),50);
    setTimeout(()=>{notif.classList.remove('show'); setTimeout(()=>notif.remove(),300);}, duration);
}

// ====== Safe DOM Element Access ======
function getElementSafe(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`Element with ID '${id}' not found`);
    }
    return element;
}

// ====== Load User Location ======
async function loadUserLocation(){
    try{
        showNotification('Loading location...', 'info');
        const response = await apiCall('/locations/real-time');
        if(response.success && response.data && response.data.length){
            currentLocation = response.data[0];
            
            // Safe DOM updates
            if (locationNameEl) locationNameEl.textContent = currentLocation.name;
            if (locationStatusEl) locationStatusEl.textContent = 'Active';
            if (statusDotEl) statusDotEl.className = 'status-dot';
            
            // Check if location has saved theme
            if(currentLocation.currentTheme){
                if (currentThemeNameEl) currentThemeNameEl.textContent = currentLocation.currentTheme.name;
                currentTheme = currentLocation.currentTheme;
                
                // Apply the saved theme from previewImage field
                if (currentLocation.currentTheme.previewImage) {
                    await loadThemeScript(currentLocation.currentTheme.previewImage);
                    showNotification('Theme loaded from database', 'success', 2000);
                }
            } else {
                if (currentThemeNameEl) currentThemeNameEl.textContent = 'No theme applied';
            }
            
            // Check if location has saved background color
            if(currentLocation.backgroundColor){
                currentBackgroundColor = currentLocation.backgroundColor;
                if (backgroundColorPickerEl) backgroundColorPickerEl.value = currentBackgroundColor;
                if (colorPreviewEl) colorPreviewEl.style.backgroundColor = currentBackgroundColor;
                document.body.style.backgroundColor = currentBackgroundColor;
            }
        } else {
            // If no location data, create a default location object
            currentLocation = {
                locationId: 'default-location',
                name: 'Default Location',
                active: true
            };
            if (locationNameEl) locationNameEl.textContent = currentLocation.name;
        }
        showNotification('Location loaded', 'success', 2000);
    } catch(e){
        console.error('Load location error:', e);
        // Create a default location if API fails
        currentLocation = {
            locationId: 'default-location',
            name: 'Default Location',
            active: true
        };
        if (locationNameEl) locationNameEl.textContent = currentLocation.name;
        if (locationStatusEl) locationStatusEl.textContent = 'Ready';
        if (statusDotEl) statusDotEl.className = 'status-dot';
        showNotification('Using default location', 'info');
    }
}

// ====== Load Themes ======
function loadThemes(){
    // Define your available themes
    themes = [
        {
            id: 'purple',
            name: 'Purple Theme',
            description: 'Professional purple theme with modern gradient design',
            color: 'linear-gradient(135deg, #7209b7 0%, #4361ee 100%)',
            scriptUrl: THEME_URLS.purple,
            // Theme properties that match your model
            addBarColor: '#7209b7',
            gradientColor: 'linear-gradient(135deg, #7209b7 0%, #4361ee 100%)',
            hoverColor: '#5a08a5',
            textColor: '#FFFFFF',
            backgroundColor: '#FFFFFF',
            buttonBgColor: '#7209b7',
            buttonTextColor: '#FFFFFF',
            buttonHoverColor: '#5a08a5',
            fontFamily: 'Arial, sans-serif',
            headingFontSize: '14px',
            bodyFontSize: '12px',
            borderRadius: '8px',
            transitionSpeed: '0.3s'
        },
        {
            id: 'yellow',
            name: 'Yellow Theme',
            description: 'Bright and energetic yellow theme',
            color: 'linear-gradient(135deg, #ffd166 0%, #ff9e00 100%)',
            scriptUrl: THEME_URLS.yellow,
            // Theme properties that match your model
            addBarColor: '#ff9e00',
            gradientColor: 'linear-gradient(135deg, #ffd166 0%, #ff9e00 100%)',
            hoverColor: '#e68a00',
            textColor: '#000000',
            backgroundColor: '#FFFFFF',
            buttonBgColor: '#ff9e00',
            buttonTextColor: '#000000',
            buttonHoverColor: '#e68a00',
            fontFamily: 'Arial, sans-serif',
            headingFontSize: '14px',
            bodyFontSize: '12px',
            borderRadius: '8px',
            transitionSpeed: '0.3s'
        }
    ];
    
    populateThemeOptions();
}

function populateThemeOptions(){
    const container = getElementSafe('themeOptions');
    if(!container) return;
    
    if(!themes.length){
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--gray)">No themes available</div>';
        return;
    }
    
    const currentId = currentTheme ? currentTheme.id : '';
    container.innerHTML = themes.map(t=>`
        <div class="theme-option ${t.id===currentId?'active':''}" data-theme-id="${t.id}">
            <div class="theme-preview" style="background:${t.color}">
                <i class="fas fa-paint-brush"></i>
            </div>
            <div class="theme-details">
                <h4>${t.name}</h4>
                <p>${t.description}</p>
            </div>
            <button class="btn btn-primary btn-sm apply-theme-btn" data-theme-id="${t.id}">
                <i class="fas fa-check"></i> Apply
            </button>
        </div>
    `).join('');

    document.querySelectorAll('.apply-theme-btn').forEach(btn=>{
        btn.addEventListener('click', e=>{
            e.stopPropagation();
            applyTheme(btn.getAttribute('data-theme-id'), true);
        });
    });
}

// ====== Apply Theme ======
async function applyTheme(themeId, saveToDB = true){
    if(!currentLocation) return showNotification('No location selected','error');
    
    try{
        showNotification('Applying theme...','info');
        
        // Find the theme
        const theme = themes.find(t => t.id === themeId);
        if(!theme) {
            showNotification('Theme not found','error');
            return;
        }
        
        // Load and execute the theme script
        await loadThemeScript(theme.scriptUrl);
        
        // Save theme to database if requested
        if(saveToDB) {
            try {
                // Create theme data that matches your Theme model
                const themeData = {
                    name: theme.name,
                    description: theme.description,
                    locationId: currentLocation.locationId,
                    userId: '110', // Using your bearer token as userId
                    companyId: currentLocation.companyId || 'default-company',
                    
                    // Store script URL in previewImage field
                    previewImage: theme.scriptUrl,
                    
                    // Theme color properties
                    addBarColor: theme.addBarColor,
                    gradientColor: theme.gradientColor,
                    hoverColor: theme.hoverColor,
                    textColor: theme.textColor,
                    backgroundColor: theme.backgroundColor,
                    buttonBgColor: theme.buttonBgColor,
                    buttonTextColor: theme.buttonTextColor,
                    buttonHoverColor: theme.buttonHoverColor,
                    
                    // Typography
                    fontFamily: theme.fontFamily,
                    headingFontSize: theme.headingFontSize,
                    bodyFontSize: theme.bodyFontSize,
                    
                    // UI Elements
                    borderRadius: theme.borderRadius,
                    transitionSpeed: theme.transitionSpeed,
                    
                    // Default settings
                    category: 'dashboard',
                    isActive: true,
                    isGlobal: false,
                    version: 1
                };

                console.log('Sending theme data:', themeData);

                const res = await apiCall('/themes/apply',{ 
                    method:'POST', 
                    body: {
                        locationId: currentLocation.locationId,
                        themeData: themeData
                    }
                });
                
                if(res.success){
                    showNotification('Theme applied and saved!','success');
                    currentTheme = theme;
                    if (currentThemeNameEl) currentThemeNameEl.textContent = currentTheme.name;
                    populateThemeOptions();
                } else {
                    showNotification(`Theme applied but failed to save: ${res.message || 'Unknown error'}`,'warning');
                }
            } catch(apiError) {
                console.error('Failed to save theme to DB:', apiError);
                showNotification('Theme applied but failed to save to database','warning');
                // Still update UI even if DB save fails
                currentTheme = theme;
                if (currentThemeNameEl) currentThemeNameEl.textContent = currentTheme.name;
                populateThemeOptions();
            }
        } else {
            // Just update UI without saving to DB
            currentTheme = theme;
            if (currentThemeNameEl) currentThemeNameEl.textContent = currentTheme.name;
            populateThemeOptions();
            showNotification('Theme applied!','success');
        }
        
    } catch(e){ 
        console.error(e); 
        showNotification('Error applying theme','error'); 
    }
}

// ====== Load Theme Script ======
function loadThemeScript(url) {
    return new Promise((resolve, reject) => {
        // Remove any existing theme scripts
        const existingScripts = document.querySelectorAll('script[data-theme-script]');
        existingScripts.forEach(script => script.remove());
        
        // Create new script element
        const script = document.createElement('script');
        script.src = url;
        script.setAttribute('data-theme-script', 'true');
        script.onload = () => {
            console.log('Theme script loaded successfully:', url);
            resolve();
        };
        script.onerror = () => {
            console.error('Failed to load theme script:', url);
            reject(new Error(`Failed to load theme script: ${url}`));
        };
        document.head.appendChild(script);
    });
}

// ====== Remove Theme ======
async function removeTheme(){
    if(!currentLocation) return showNotification('No location selected','error');
    if(!currentTheme && !document.querySelector('script[data-theme-script]')) {
        return showNotification('No theme to remove','error');
    }
    
    if(!confirm('Are you sure you want to remove the current theme?')) return;
    
    try{
        showNotification('Removing theme...','info');
        
        // Remove theme script
        const existingScripts = document.querySelectorAll('script[data-theme-script]');
        existingScripts.forEach(script => script.remove());
        
        // Save removal to database
        try {
            const res = await apiCall('/themes/remove',{ 
                method:'POST', 
                body:{ 
                    locationId: currentLocation.locationId 
                } 
            });
            
            if(res.success){
                showNotification('Theme removed!','success');
            } else {
                showNotification(`Theme removed but failed to update database: ${res.message || 'Unknown error'}`,'warning');
            }
        } catch(apiError) {
            console.error('Failed to remove theme from DB:', apiError);
            showNotification('Theme removed but failed to update database','warning');
        }
        
        currentTheme = null;
        if (currentThemeNameEl) currentThemeNameEl.textContent = 'No theme applied';
        populateThemeOptions();
        
    } catch(e){ 
        console.error(e); 
        showNotification('Error removing theme','error'); 
    }
}

// ====== Background Color Functions ======
function initBackgroundColorPicker() {
    backgroundColorPickerEl = getElementSafe('backgroundColorPicker');
    colorPreviewEl = getElementSafe('colorPreview');
    const applyColorBtn = getElementSafe('applyColorBtn');
    const resetColorBtn = getElementSafe('resetColorBtn');
    const colorPresets = document.querySelectorAll('.color-preset');
    
    if (!backgroundColorPickerEl || !colorPreviewEl || !applyColorBtn || !resetColorBtn) {
        console.error('Background color picker elements not found');
        return;
    }
    
    // Update preview when color picker changes
    backgroundColorPickerEl.addEventListener('input', (e) => {
        colorPreviewEl.style.backgroundColor = e.target.value;
    });
    
    // Apply background color
    applyColorBtn.addEventListener('click', async () => {
        const color = backgroundColorPickerEl.value;
        await applyBackgroundColor(color);
    });
    
    // Reset to default
    resetColorBtn.addEventListener('click', async () => {
        backgroundColorPickerEl.value = '#ffffff';
        colorPreviewEl.style.backgroundColor = '#ffffff';
        await applyBackgroundColor('#ffffff');
    });
    
    // Handle preset colors
    colorPresets.forEach(preset => {
        preset.addEventListener('click', async () => {
            const color = preset.getAttribute('data-color');
            backgroundColorPickerEl.value = color;
            colorPreviewEl.style.backgroundColor = color;
            await applyBackgroundColor(color);
            
            // Update active state
            colorPresets.forEach(p => p.classList.remove('active'));
            preset.classList.add('active');
        });
    });
}

async function applyBackgroundColor(color) {
    if (!currentLocation) return;
    
    try {
        showNotification('Applying background color...', 'info');
        
        // Apply color to page
        document.body.style.backgroundColor = color;
        currentBackgroundColor = color;
        
        // Save to localStorage since we don't have the API endpoint
        localStorage.setItem(`bgColor-${currentLocation.locationId}`, color);
        showNotification('Background color saved locally!', 'success');
        
    } catch (e) {
        console.error('Error applying background color:', e);
        showNotification('Error applying background color', 'error');
    }
}

// ====== Drag Widget ======
function initDrag(){
    const widget = getElementSafe('themeWidget');
    const header = getElementSafe('widgetHeader');
    
    if (!widget || !header) {
        console.error('Widget elements not found for drag initialization');
        return;
    }
    
    header.addEventListener('mousedown', startDrag);
    header.addEventListener('touchstart', startDrag);

    function startDrag(e){
        e.preventDefault(); 
        isDragging=true;
        const clientX=e.clientX||e.touches[0].clientX;
        const clientY=e.clientY||e.touches[0].clientY;
        const rect=widget.getBoundingClientRect();
        dragOffset.x=clientX-rect.left; 
        dragOffset.y=clientY-rect.top;
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('touchmove', onDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchend', stopDrag);
    }
    
    function onDrag(e){
        if(!isDragging) return;
        const clientX=e.clientX||e.touches[0].clientX;
        const clientY=e.clientY||e.touches[0].clientY;
        currentPosition.x=clientX-dragOffset.x;
        currentPosition.y=clientY-dragOffset.y;
        const maxX=window.innerWidth-widget.offsetWidth;
        const maxY=window.innerHeight-widget.offsetHeight;
        currentPosition.x=Math.max(0,Math.min(currentPosition.x,maxX));
        currentPosition.y=Math.max(0,Math.min(currentPosition.y,maxY));
        widget.style.left=currentPosition.x+'px';
        widget.style.top=currentPosition.y+'px';
        widget.style.right='auto';
        widget.style.bottom='auto';
    }
    
    function stopDrag(){
        isDragging=false;
        document.removeEventListener('mousemove',onDrag);
        document.removeEventListener('touchmove',onDrag);
        document.removeEventListener('mouseup',stopDrag);
        document.removeEventListener('touchend',stopDrag);
    }
}

// ====== Controls ======
function initControls(){
    const widget = getElementSafe('themeWidget');
    const minimizeBtn = getElementSafe('minimizeBtn');
    const closeBtn = getElementSafe('closeBtn');
    const removeBtn = getElementSafe('removeThemeBtn');

    if (!widget || !minimizeBtn || !closeBtn || !removeBtn) {
        console.error('Control elements not found');
        return;
    }

    minimizeBtn.addEventListener('click', e=>{
        e.stopPropagation();
        widget.classList.toggle('minimized');
        minimizeBtn.innerHTML = widget.classList.contains('minimized') ? '<i class="fas fa-plus"></i>' : '<i class="fas fa-minus"></i>';
    });

    closeBtn.addEventListener('click', e=>{
        e.stopPropagation();
        widget.style.display='none';
        setTimeout(()=>widget.style.display='block',5000);
        showNotification('Widget hidden. Will reappear in 5 seconds','info');
    });

    removeBtn.addEventListener('click', removeTheme);
}

// ====== Initialize DOM References ======
function initializeDomReferences() {
    statusDotEl = getElementSafe('statusDot');
    locationStatusEl = getElementSafe('locationStatus');
    locationNameEl = getElementSafe('locationName');
    currentThemeNameEl = getElementSafe('currentThemeName');
    backgroundColorPickerEl = getElementSafe('backgroundColorPicker');
    colorPreviewEl = getElementSafe('colorPreview');
}

// ====== Initialize ======
document.addEventListener('DOMContentLoaded', async ()=>{
    // Initialize DOM references first
    initializeDomReferences();
    
    // Then initialize functionality
    initDrag();
    initControls();
    initBackgroundColorPicker();
    await loadUserLocation();
    loadThemes();
});
</script>

</body>
</html>
